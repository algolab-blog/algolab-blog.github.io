<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Tips on ALGO GEEKS</title>
    <link>http://blog.algolab.jp/tags/tips/</link>
    <description>Recent content in Tips on ALGO GEEKS</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja</language>
    <lastBuildDate>Fri, 09 Dec 2016 15:03:23 +0900</lastBuildDate>
    <atom:link href="http://blog.algolab.jp/tags/tips/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>PhantomJSでPromiseが使えない場合の対処法 〜Can&#39;t find variable: Promise〜</title>
      <link>http://blog.algolab.jp/post/2016/12/09/phantomjs-promise/</link>
      <pubDate>Fri, 09 Dec 2016 15:03:23 +0900</pubDate>
      
      <guid>http://blog.algolab.jp/post/2016/12/09/phantomjs-promise/</guid>
      <description>

&lt;p&gt;Selenium + PhantomJS でDjangoアプリケーションのテストをしていたのですが、なぜか上手く動作しない箇所がありました。&lt;/p&gt;

&lt;p&gt;原因としては、外部ライブラリが &lt;a href=&#34;https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Promise&#34;&gt;Promise&lt;/a&gt; を用いており、PhantomJSがサポートしていないためで、&lt;a href=&#34;https://github.com/stefanpenner/es6-promise&#34;&gt;es6-promise&lt;/a&gt; を明示的に読み込ませることで解決しました。&lt;/p&gt;

&lt;p&gt;以下に再現のためのサンプルコードを書いてみます。&lt;/p&gt;

&lt;h2 id=&#34;サンプルコード&#34;&gt;サンプルコード&lt;/h2&gt;

&lt;p&gt;以下の2つのファイルを用意します。&lt;code&gt;test.html&lt;/code&gt;は&lt;code&gt;http://localhost/test.html&lt;/code&gt;で読み込めることを前提としています。&lt;/p&gt;

&lt;p&gt;test.html&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;script&amp;gt;
  var hoge = 1;
  console.log(Promise);
  var hoge = 2;
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;test.py&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;from selenium import webdriver

driver = webdriver.PhantomJS()
driver.get(&#39;http://localhost/test.html&#39;)
hoge = driver.execute_script(&#39;return hoge&#39;)
print(hoge)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;test.py&lt;/code&gt;を実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ python test.py
1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;hoge&lt;/code&gt;の値が&lt;code&gt;1&lt;/code&gt;であり、&lt;code&gt;console.log(Promise);&lt;/code&gt;以降処理が行われていないことがわかります。&lt;br /&gt;
&lt;code&gt;ghostdriver.log&lt;/code&gt;にログが出力されるので、みてみると下記のエラーが出力されていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[ERROR - 2016-12-09T05:54:22.556Z] Session [eee84f50-bdd3-11e6-87a5-f36dec782eab] - page.onError - msg: ReferenceError: Can&#39;t find variable: Promise
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;続いて、&lt;code&gt;test.html&lt;/code&gt;で&lt;code&gt;es6-promise&lt;/code&gt;を明示的に読み込ませるように修正します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;script src=&amp;quot;https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.0.5/es6-promise.auto.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;script&amp;gt;
  var hoge = 1;
  console.log(Promise);
  var hoge = 2;
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;$ python test.py
2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;きちんと処理が行われるようになりました。&lt;/p&gt;

&lt;p&gt;GitHub上でも下記の議論が行われており、&lt;code&gt;ES6&lt;/code&gt; のサポートが本体に導入されることを待つばかりです。&lt;br /&gt;
&lt;a href=&#34;https://github.com/ariya/phantomjs/issues/12401&#34;&gt;https://github.com/ariya/phantomjs/issues/12401&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>